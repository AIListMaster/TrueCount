{% extends "layouts/base.html" %}

{% block content %}
<section class="bg-white dark:bg-gray-900 ">
  <div class="py-8 px-4 mx-auto text-center lg:py-16">
    <div id="searchApp" class="relative">
      <h1
        class="mb-4 text-4xl font-extrabold tracking-tight leading-none text-gray-900 md:text-5xl lg:text-6xl dark:text-white">
        Search for businesses</h1>
      <p class="mb-8 text-lg font-normal text-gray-500 lg:text-xl sm:px-16 lg:px-48 dark:text-gray-400">The Trucount
        sentiment analysis AI will take approximately 2 to 3 minutes to gather all the reviews of the business and
        perform
        analysis. Please bear with us during this process.</p>
      <div class="flex flex-col space-y-4 sm:flex-row sm:justify-center sm:space-y-0">
        <form @submit.prevent="submitForm" class="w-1/2">
          {{ form.hidden_tag() }}
          <label for="search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">Search</label>
          <div class="relative">
            <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
              <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                   xmlns="http://www.w3.org/2000/svg"
                   fill="none" viewBox="0 0 20 20">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
              </svg>
            </div>
            {{ form.search_term(placeholder="Search", id="search", required="required",
            class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50
            focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400
            dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500", **{"v-model": "formData.search_term"})
            }}
            <button type="submit"
                    class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
              Search
            </button>
          </div>
        </form>
        <div v-if="isLoading" class="absolute flex top-0 left-0 h-full w-full bg-white/50">
          <div
            class="h-16 w-16 m-auto animate-spin rounded-full border-4 border-solid border-primary border-t-transparent"></div>
        </div>
      </div>
    </div>
  </div>
</section>
<section class="py-8 lg:py-16 px-4 sm:mt-4 lg:mt-8 max-w-screen-lg mx-auto">
  <div class="grid gap-10 md:grid-cols-2 lg:gap-10 xl:grid-cols-3">
    {% for item in items %}
    <div class="group cursor-pointer">
      <div class=" overflow-hidden rounded-md bg-gray-100 transition-all hover:scale-105   dark:bg-gray-800">
        <a class="relative block aspect-square" href="/business/{{ item.id }}">
          {% if item.image %}
          <div class="bg-indigo-300 h-full rounded-lg overflow-hidden">
            <img class="object-cover w-full h-full min-w-75" src="{{ item.image }}" alt="Photo of {{ item.title }}">
          </div>
          {% endif %}
        </a>
      </div>
      <div>
        {% if item.category %}
        <div class="flex gap-3">
          <a href="#">
            <span class="inline-block text-xs font-medium tracking-wider uppercase mt-5 text-blue-600">
              {{ item.category }}
            </span>
          </a>
        </div>
        {% endif %}
        <h2 class="text-lg font-semibold leading-snug tracking-tight mt-2 dark:text-white">
          <a href="/business/{{ item.id }}">
            <span
              class="bg-gradient-to-r from-meta-9 to-secondary bg-[length:0px_10px] bg-left-bottom bg-no-repeat transition-[background-size] duration-500 hover:bg-[length:100%_3px] group-hover:bg-[length:100%_10px] dark:from-purple-800 dark:to-purple-900">
              {{ item.title }}
            </span>
          </a>
        </h2>
        {% if item.address %}
        <div class="">
          <p class="mt-2 line-clamp-3 text-sm text-graydark">
            <a href="/business/{{ item.id }}">{{ item.address }}</a>
          </p>
        </div>
        {% endif %}
        <div class="mt-3 flex items-center space-x-3 text-bodydark2">
          <a href="#">
            <div class="flex items-center gap-3">
              <div class="relative h-5 w-5 flex-shrink-0">
                <i class="fa-solid fa-star-half-stroke"></i>
              </div>
              <span class="truncate text-sm">AI System</span>
            </div>
          </a>
          <span class="text-xs text-gray-300 dark:text-gray-600">â€¢</span>
          <time class="truncate text-sm" datetime="2022-10-18T14:49:00.000Z">{{ item.updated }}</time>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endblock content %}

{% block javascripts %}
<script>
  const {createApp, ref} = Vue;
  const searchApp = createApp({
    data() {
      return {
        formData: {
          search_term: '',
        },
        isLoading: false,
      };
    },
    methods: {
      async submitForm() {
        // Simulate an asynchronous operation (e.g., API call)
        this.isLoading = true;

        try {
          const response = await fetch('/analyse', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(this.formData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          // Parse the JSON response
          const responseData = await response.json();

          // Log the response data
          console.log('Response:', responseData);

          this.isLoading = false;
        } catch (error) {
          console.error('Error submitting form:', error);
          // Reset loader state on error
          this.isLoading = false;
        }
      },
    },
  });

  searchApp.mount('#searchApp');
</script>

{% endblock javascripts %}